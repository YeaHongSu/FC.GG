{% extends 'base.html' %}

{% block title %}FC.GG - 포지션별 선수 티어{% endblock %}

{% block extra_meta %}
<meta name="naver-site-verification" content="c1b0a71b768a10669f82da810f13bc34f3953457" />
<meta name="keywords" content="피파, 피파온라인, 피파온라인4, FC온라인, 선수 티어, 에프씨지지, fcgg, fc.gg">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/player_tier.css') }}">
{% endblock %}

{% block content %}
<section class="tier-section">
    <h1 class="page-title">내가 쓰는 선수 티어는 무엇일까?</h1>
    <p class="page-subtitle">랭커 기준 선수 티어를 확인해 보세요!</p>

    <div id="vm-center-banner"
         style="width:100%; display:flex; justify-content:center; margin:32px 0;">
    </div>

    <!-- ✅ 상단: 좌(포지션별 선수 티어 카드) + 우(비디오 광고 카드) -->
    <div class="tier-top-grid">
        <!-- Left: Position Container -->
        <div class="card-modern position-container tier-left-card">
            <div class="card-header-modern">
                <h2 class="card-title-modern">포지션별 선수 티어</h2>
            </div>
            <div class="card-body-modern">
                <div class="position-controls">
                    <!-- Position Tabs -->
                    <div class="position-tabs">
                        <button class="position-tab active" data-position-options="ST,CF,LW,RW">공격수</button>
                        <button class="position-tab" data-position-options="CAM,CM,CDM">미드필더</button>
                        <button class="position-tab" data-position-options="CB,LB,RB">수비수</button>
                        <button class="position-tab" data-position-options="GK">골키퍼</button>
                    </div>

                    <!-- Position Dropdown -->
                    <select id="positionDropdown" class="position-dropdown"></select>
                </div>

                <!-- Player Search -->
                <div class="player-search">
                    <input type="text" id="playerSearchInput" class="search-input" placeholder="선수 이름을 입력하세요">
                    <button class="search-btn" id="searchPlayerButton">검색</button>
                </div>
            </div>
        </div>

        <!-- Right: Video Ad (카드 밖 오른쪽) -->
        <div class="card-modern tier-video-card">
            <div class="card-body-modern tier-video-body">
                <!-- ✅ 여기 안에 광고 스크립트가 iframe/video 등을 주입 -->
                <div id="video" class="tier-video-slot"></div>
            </div>
        </div>
    </div>

    <!-- Top Player Box -->
    <div id="top-player" class="top-player-box card-modern">
        <div class="card-body-modern">
            <h3 class="top-player-title">
                <span id="position-name" class="text-primary">ST</span> 최고 OP 선수
            </h3>
            <div class="tier-badge tier-0">BEST OP</div>
            <div id="top-players-container" class="top-players-row">
                <!-- Top players will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Tier List -->
    <div id="tier-list" class="tier-list">
        <div class="tier-header">
            <div class="tier-column">티어</div>
            <div class="tier-column">시즌</div>
            <div class="tier-column">선수 이름</div>
            <div class="tier-column">FC스코어</div>
            <div class="tier-column">출전</div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    const playerTierData = {{ tier_forward_list | tojson }};

    // Position tab click events
    document.querySelectorAll('.position-tab').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.position-tab').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const positionOptions = this.getAttribute('data-position-options');
            updateDropdownOptions(positionOptions);
            updateTopPlayer(positionOptions.split(',')[0]);
        });
    });

    // Initial setup
    updateDropdownOptions('ST,CF,RW,LW');
    updateTopPlayer('ST');

    // Player search
    document.getElementById("searchPlayerButton").addEventListener("click", function() {
        const playerName = document.getElementById("playerSearchInput").value.trim();
        const position = document.getElementById("positionDropdown").value;
        if (playerName) {
            searchPlayerByName(playerName, position);
        }
    });

    document.getElementById("playerSearchInput").addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            document.getElementById("searchPlayerButton").click();
        }
    });

    function searchPlayerByName(name, position) {
        const tierListContainer = document.getElementById('tier-list');
        tierListContainer.innerHTML = `
            <div class="tier-header">
                <div class="tier-column">티어</div>
                <div class="tier-column">시즌</div>
                <div class="tier-column">선수 이름</div>
                <div class="tier-column">FC스코어</div>
                <div class="tier-column">출전</div>
            </div>`;

        const sortedTiers = ['0티어', '1티어', '2티어', '3티어', '4티어', '5티어'];
        let found = false;

        sortedTiers.forEach(tier => {
            if (playerTierData[position] && playerTierData[position][tier]) {
                const players = playerTierData[position][tier];
                players.forEach(player => {
                    if (player['선수 이름'].includes(name)) {
                        found = true;
                        const tierItem = document.createElement('div');
                        tierItem.classList.add('tier-item', `tier-${tier.charAt(0)}`);

                        const tierIcon = document.createElement('div');
                        tierIcon.classList.add('tier-icon');
                        tierIcon.innerText = tier.charAt(0) === '0' ? 'OP' : `${tier.charAt(0)}티어`;

                        const playerDetails = `
                            <div class="tier-column"><img src="${player['시즌']}" alt="시즌" class="season-img"></div>
                            <div class="tier-column player-cell">
                                <img src="${player['미니페이스온']}" alt="미니페이스온" class="face-img">
                                <span>${player['선수 이름']}</span>
                            </div>
                            <div class="tier-column">${player['FC스코어']}</div>
                            <div class="tier-column">${player['출전']}</div>`;

                        tierItem.innerHTML = tierIcon.outerHTML + playerDetails;
                        tierListContainer.appendChild(tierItem);
                    }
                });
            }
        });

        if (!found) {
            tierListContainer.innerHTML += '<p class="no-result">해당 선수가 없습니다.</p>';
        }
    }

    function updateDropdownOptions(options) {
        const dropdown = document.getElementById('positionDropdown');
        dropdown.innerHTML = '';
        options.split(',').forEach(function(option) {
            const newOption = document.createElement('option');
            newOption.value = option;
            newOption.text = option;
            dropdown.appendChild(newOption);
        });
        updateTierList(dropdown.value);
        updateTopPlayer(dropdown.value);
    }

    document.getElementById('positionDropdown').addEventListener('change', function() {
        updateTierList(this.value);
        updateTopPlayer(this.value);
    });

    function updateTopPlayer(position) {
        const tiers = playerTierData[position];
        document.getElementById('position-name').textContent = position;
        const container = document.getElementById('top-players-container');
        container.innerHTML = '';

        if (tiers && tiers['0티어'] && tiers['0티어'].length > 0) {
            tiers['0티어'].forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('top-player-card');
                playerCard.innerHTML = `
                    <img src="${player['미니페이스온']}" alt="미니페이스온" class="player-face">
                    <img src="${player['시즌']}" alt="시즌" class="season-icon">
                    <p class="player-name">${player['선수 이름']}</p>
                    <p class="player-score">FC스코어: ${player['FC스코어']}</p>
                `;
                container.appendChild(playerCard);
            });
            document.getElementById('top-player').style.display = 'block';
        } else {
            document.getElementById('top-player').style.display = 'none';
        }
    }

    function updateTierList(position) {
        const tierListContainer = document.getElementById('tier-list');
        tierListContainer.innerHTML = `
            <div class="tier-header">
                <div class="tier-column">티어</div>
                <div class="tier-column">시즌</div>
                <div class="tier-column">선수 이름</div>
                <div class="tier-column">FC스코어</div>
                <div class="tier-column">출전</div>
            </div>`;

        const sortedTiers = ['0티어', '1티어', '2티어', '3티어', '4티어', '5티어'];
        const tiers = playerTierData[position];

        if (tiers) {
            sortedTiers.forEach(tier => {
                if (tiers[tier]) {
                    tiers[tier].forEach(player => {
                        const tierItem = document.createElement('div');
                        tierItem.classList.add('tier-item', `tier-${tier.charAt(0)}`);

                        const tierIcon = document.createElement('div');
                        tierIcon.classList.add('tier-icon');
                        tierIcon.innerText = tier.charAt(0) === '0' ? 'OP' : `${tier.charAt(0)}티어`;

                        const playerDetails = `
                            <div class="tier-column"><img src="${player['시즌']}" alt="시즌" class="season-img"></div>
                            <div class="tier-column player-cell">
                                <img src="${player['미니페이스온']}" alt="미니페이스온" class="face-img">
                                <span>${player['선수 이름']}</span>
                            </div>
                            <div class="tier-column">${player['FC스코어']}</div>
                            <div class="tier-column">${player['출전']}</div>`;

                        tierItem.innerHTML = tierIcon.outerHTML + playerDetails;
                        tierListContainer.appendChild(tierItem);
                    });
                }
            });
        } else {
            tierListContainer.innerHTML += '<p class="no-result">해당 포지션에 대한 티어 정보가 없습니다.</p>';
        }
    }
</script>
{% endblock %}
