{% extends 'base.html' %}

{% block title %}FC.GG - ì „ì  ê²€ìƒ‰ ê²°ê³¼{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
{% endblock %}

{% block loading %}
<!-- Loading Overlays -->
<div class="loading-overlay" id="loading-win">
    <div class="loading-spinner"></div>
    <div class="loading-text">ìœ ì €ë‹˜ì˜ ìŠ¹ë¥ ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤!</div>
</div>

<div class="loading-overlay" id="loading-result">
    <div class="loading-spinner"></div>
    <div class="loading-text">ê²½ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤!</div>
</div>
{% endblock %}

{% block content %}
<!-- Search Section -->
<section class="search-section">
    <div class="search-wrapper">
        <input type="text" id="character_name" class="search-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button class="search-btn" id="search_button">ê²€ìƒ‰</button>
    </div>
</section>

<!-- ğŸ”¹ ì¤‘ì•™ ë°°ë„ˆ -->
<div id="vm-top-banner"
     style="width:100%; display:flex; justify-content:center; margin:32px 0;">
</div>

<!-- Player Info Card -->
<div class="card-modern player-info-card">
    <div class="card-header-modern">
        <h2 class="card-title-modern">
            ê¸°ë³¸ì •ë³´
            <button class="bookmark-btn header-bookmark" id="bookmark-btn" onclick="toggleBookmark('{{ level_data.nickname }}')">â˜…</button>
        </h2>
    </div>

    <div class="card-body-modern">
        <!-- âœ… ì—¬ê¸°ë¶€í„°: ì¢Œ(ê¸°ë³¸ì •ë³´) + ìš°(ë¹„ë””ì˜¤) ë ˆì´ì•„ì›ƒ ë˜í¼ -->
        <div class="player-info-layout">

            <!-- LEFT: ê¸°ì¡´ ê¸°ë³¸ì •ë³´ ì˜ì—­ -->
            <div class="player-info-left">
                <div class="player-info-content">
                    <!-- Mobile Layout: tier, level, nickname, bookmark in one row -->
                    <div class="player-info-mobile">
                        {% if level_data.tier_image %}
                        <img src="{{ level_data.tier_image }}" alt="í‹°ì–´" class="tier-image-mobile">
                        {% else %}
                        <span class="tier-text-mobile">{{ level_data.tier_name }}</span>
                        {% endif %}
                        <span class="level-mobile">Lv.{{ level_data.level }}</span>
                        <span class="player-nickname-mobile">{{ level_data.nickname }}</span>
                        <span class="player-badge" id="title-box-mobile" style="display: none;"></span>
                    </div>

                    <!-- Desktop Layout -->
                    <div class="player-info-desktop">
                        <div class="player-main">
                            <span class="player-nickname">{{ level_data.nickname }}</span>
                            <span class="player-badge" id="title-box" style="display: none;"></span>
                        </div>
                        <div class="player-stats">
                            <div class="stat-item">
                                <div class="stat-label">ë ˆë²¨</div>
                                <div class="stat-value">{{ level_data.level }}</div>
                            </div>
                            {% if level_data.tier_image %}
                            <div class="stat-item">
                                <div class="stat-label">ìµœê³  í‹°ì–´</div>
                                <img src="{{ level_data.tier_image }}" alt="í‹°ì–´" class="tier-image">
                            </div>
                            {% else %}
                            <div class="stat-item">
                                <div class="stat-label">ìµœê³  í‹°ì–´</div>
                                <div class="stat-value">{{ level_data.tier_name }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: ë¹„ë””ì˜¤ ì˜ì—­ (âœ… ë¹¨ê°„ ë°•ìŠ¤ ìë¦¬) -->
            <aside class="player-info-right" aria-label="video">
                <div id="video" class="result-video"></div>
            </aside>

        </div>
        <!-- âœ… ì—¬ê¸°ê¹Œì§€ -->
    </div>
</div>

<!-- Game Mode Tabs -->
<div class="game-mode-tabs">
    <button class="tab-item {% if match_type == '50' %}active{% endif %}" id='50' onclick="selectGameMode('{{ level_data.nickname }}', '50', this)">ê³µì‹ê²½ê¸°</button>
    <button class="tab-item {% if match_type == '60' %}active{% endif %}" id='60' onclick="selectGameMode('{{ level_data.nickname }}', '60', this)">ì¹œì„ ê²½ê¸°</button>
    <button class="tab-item {% if match_type == '52' %}active{% endif %}" id='52' onclick="selectGameMode('{{ level_data.nickname }}', '52', this)">ê°ë…ëª¨ë“œ</button>
    <button class="tab-item {% if match_type == '40' %}active{% endif %}" id='40' onclick="selectGameMode('{{ level_data.nickname }}', '40', this)">ì»¤ìŠ¤í…€ë§¤ì¹˜</button>
</div>

{% if no_recent_matches %}
<div class="card-modern">
    <div class="card-body-modern">
        <p class="no-match-message">ìµœê·¼ ì „ì ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </div>
</div>
{% else %}

<!-- Play Style Card -->
<div class="card-modern play-style-card">
    <div class="card-header-modern">
        <h3 class="card-title-modern">í”Œë ˆì´ìŠ¤íƒ€ì¼</h3>
    </div>
    <div class="card-body-modern" id="player-style">
        <p class="play-style-text">
            <span class="play-style-name">{{ level_data.nickname }}ë‹˜ì€</span>
            <span class="play-style-value">{{ play_style }}</span>
            <span class="play-style-suffix">ì…ë‹ˆë‹¤!</span>
        </p>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <!-- Left Column: Win Rate + Controller -->
    <div class="stats-column">
        <!-- Win Rate Card -->
        <div class="card-modern">
            <div class="card-header-modern">
                <h3 class="card-title-modern">ìµœê·¼ <span style="color: var(--primary-green);">{{ match_data|length }}</span>ê²½ê¸° ìŠ¹ë¥ </h3>
            </div>
            <div class="card-body-modern winrate-section">
                <p class="winrate-summary">
                    {{ match_data|length }}ì „
                    {{ match_data|selectattr('ê²°ê³¼', 'equalto', 'ìŠ¹')|list|length }}ìŠ¹
                    {{ match_data|selectattr('ê²°ê³¼', 'equalto', 'ë¬´')|list|length }}ë¬´
                    {{ match_data|selectattr('ê²°ê³¼', 'equalto', 'íŒ¨')|list|length }}íŒ¨
                </p>
                <div class="chart-wrapper">
                    <canvas id="winRateChart"></canvas>
                    <div class="winrate-percentage" id="winRatePercentage"></div>
                </div>
                <p class="winrate-message" id="winRateMessage"></p>
                <p style="color: var(--text-secondary); margin-bottom: 12px;">ë‚˜ì˜ ìŠ¹ë¥ ì„ ë†’ì´ëŠ” ë°©ë²•ì€?</p>
                <a class="btn-primary" href="javascript:void(0);" onclick="goToWinRateResult('{{level_data.nickname}}','{{match_type}}')">
                    ìŠ¹ë¥  ê°œì„  ì†”ë£¨ì…˜
                </a>
            </div>
        </div>

        <!-- Controller Recommendation Card -->
        <div class="card-modern controller-card">
            <div class="card-body-modern">
                <p class="controller-text">
                    <span style="color: var(--primary-green); font-weight: 600;">{{ level_data.nickname }}</span>ë‹˜ì€
                    <strong>{{ most_common_controller }}</strong> ìœ ì €ì…ë‹ˆë‹¤
                </p>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">{{ most_common_controller }}ì— ëŒ€í•œ íŒì„ ì°¾ê±°ë‚˜ ê³µìœ í•´ ë³´ì„¸ìš”!</p>
                {% if most_common_controller == "âŒ¨ï¸" or most_common_controller == "íƒˆì£¼" %}
                <a class="btn-accent" href="https://fcgg.kr/ì»¤ë®¤ë‹ˆí‹°/í‚¤ë³´ë“œê²Œì‹œíŒ" target="_blank">í‚¤ë³´ë“œê²Œì‹œíŒ ë°”ë¡œê°€ê¸°</a>
                {% else %}
                <a class="btn-accent" href="https://fcgg.kr/ì»¤ë®¤ë‹ˆí‹°/íŒ¨ë“œê²Œì‹œíŒ" target="_blank">íŒ¨ë“œê²Œì‹œíŒ ë°”ë¡œê°€ê¸°</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Squad Card -->
    <div class="card-modern squad-card">
        <div class="card-header-modern">
            <h3 class="card-title-modern"><span style="color: var(--primary-green);">{{ level_data.nickname }}</span>ë‹˜ì˜ ìŠ¤ì¿¼ë“œ</h3>
        </div>
        <div class="card-body-modern">
            <p class="squad-mode-label">
                {% if match_type == '50' %}[ê³µì‹ê²½ê¸° ê¸°ì¤€]
                {% elif match_type == '60' %}[ì¹œì„ ê²½ê¸° ê¸°ì¤€]
                {% elif match_type == '52' %}[ê°ë…ëª¨ë“œ ê¸°ì¤€]
                {% elif match_type == '40' %}[ì»¤ìŠ¤í…€ë§¤ì¹˜ ê¸°ì¤€]
                {% else %}[ìµœê·¼ ê²½ê¸° ê¸°ì¤€]{% endif %}
            </p>
            <div class="squad-field">
                {% for player in players %}
                {% if player.x_coord and player.y_coord %}
                <div class="player-marker" style="left: {{ player.x_coord }}%; top: {{ player.y_coord }}%;">
                    {% if player.pos_desc %}
                    <div class="position-tag">{{ player.pos_desc }}</div>
                    {% endif %}
                    <img src="{{ player.sd_image }}" alt="{{ player.name }}" class="player-img">
                    <div class="player-name-tag">{{ player.name }}</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Metrics Grid -->
<div class="metrics-grid">
    <!-- Top 5 Metrics -->
    <div class="card-modern">
        <div class="card-header-modern">
            <h3 class="card-title-modern">ë­ì»¤ ëŒ€ë¹„ ìƒìœ„ <span style="color: var(--primary-green);">5</span>ê°œ ì§€í‘œ</h3>
        </div>
        <div class="card-body-modern">
            <ul class="metrics-list">
                {% for idx, value in max_data %}
                <li class="metrics-item">
                    <span>
                        <span class="metrics-rank positive">Top{{ loop.index }}</span>
                        <span class="metrics-label">{{ data_label[idx] }}</span>
                    </span>
                    <span class="metrics-value positive">
                        {{ "%.2f"|format(value * 100) }}%
                        <span>â–²</span>
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Bottom 5 Metrics -->
    <div class="card-modern">
        <div class="card-header-modern">
            <h3 class="card-title-modern">ë­ì»¤ ëŒ€ë¹„ í•˜ìœ„ <span style="color: var(--lose-red);">5</span>ê°œ ì§€í‘œ</h3>
        </div>
        <div class="card-body-modern">
            <ul class="metrics-list">
                {% for idx, value in min_data %}
                <li class="metrics-item">
                    <span>
                        <span class="metrics-rank negative">Top{{ loop.index }}</span>
                        <span class="metrics-label">{{ data_label[idx] }}</span>
                    </span>
                    <span class="metrics-value negative">
                        {{ "%.2f"|format(-value * 100) }}%
                        <span>â–¼</span>
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Opponent Stats Section -->
<section class="card-modern opponent-section" id="opponentStatsSection">
    <div class="card-header-modern">
        <h3 class="card-title-modern">ìƒëŒ€ ì „ì </h3>
    </div>
    <div class="card-body-modern">
        <div class="opponent-grid" id="opponent-stats-list"></div>
    </div>
</section>

<!-- ğŸ”¹ ì¤‘ì•™ ë°°ë„ˆ -->
<div id="vm-center-banner"
     style="width:100%; display:flex; justify-content:center; margin:32px 0;">
</div>

<!-- Match History Section -->
<section class="card-modern match-section">
    <div class="card-header-modern">
        <h3 class="card-title-modern">ë§¤ì¹­ ì •ë³´</h3>
    </div>
    <div class="card-body-modern">
        <div class="match-header">
            <div>ë§¤ì¹˜ ë‚ ì§œ</div>
            <div>ê²°ê³¼</div>
            <div>ë‚˜ vs ìƒëŒ€</div>
            <div>ìŠ¤ì½”ì–´</div>
            <div>ì»¨íŠ¸ë¡¤ëŸ¬</div>
        </div>
        <div class="match-list">
            {% for match in match_data %}
            <div class="match-row {% if match['ê²°ê³¼'] == 'ìŠ¹' %}win{% elif match['ê²°ê³¼'] == 'ë¬´' %}draw{% else %}lose{% endif %}">
                <span class="match-date">{{ match['ë§¤ì¹˜ ë‚ ì§œ'] }}</span>
                <span class="match-result">{{ match['ê²°ê³¼'] }}</span>
                <div class="match-players">
                    <span class="match-player">{{ match['í”Œë ˆì´ì–´ 1 vs í”Œë ˆì´ì–´ 2'].split(' vs ')[0] }}</span>
                    <span class="match-vs">vs</span>
                    <span class="match-player">{{ match['í”Œë ˆì´ì–´ 1 vs í”Œë ˆì´ì–´ 2'].split(' vs ')[1] }}</span>
                </div>
                <span class="match-score">{{ match['ìŠ¤ì½”ì–´'] }}</span>
                <span class="match-controller">{{ match['ì»¨íŠ¸ë¡¤ëŸ¬'] }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- ğŸ”¹ ì¤‘ì•™ ë°°ë„ˆ -->
<div id="vm-bottom-banner"
     style="width:100%; display:flex; justify-content:center; margin:32px 0;">
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const matchData = {{ match_data | tojson }};

    // Opponent Stats Calculation
    function calculateOpponentStats() {
        const opponentStats = {};
        matchData.forEach(match => {
            const players = match['í”Œë ˆì´ì–´ 1 vs í”Œë ˆì´ì–´ 2'].split(' vs ');
            const opponent = players[1].trim();
            if (!opponentStats[opponent]) {
                opponentStats[opponent] = { total: 0, wins: 0, draws: 0, losses: 0 };
            }
            opponentStats[opponent].total += 1;
            if (match['ê²°ê³¼'] === 'ìŠ¹') opponentStats[opponent].wins += 1;
            else if (match['ê²°ê³¼'] === 'ë¬´') opponentStats[opponent].draws += 1;
            else if (match['ê²°ê³¼'] === 'íŒ¨') opponentStats[opponent].losses += 1;
        });

        const topOpponents = Object.entries(opponentStats)
            .sort((a, b) => b[1].total - a[1].total)
            .slice(0, 3);

        const opponentStatsList = document.getElementById('opponent-stats-list');
        opponentStatsList.innerHTML = '';

        topOpponents.forEach(([opponent, stats], index) => {
            const winRate = ((stats.wins / stats.total) * 100).toFixed(1);
            const opponentCard = document.createElement('div');
            opponentCard.classList.add('opponent-card');
            opponentCard.innerHTML = `
                <div class="opponent-info">
                    <span class="opponent-rank">Top ${index + 1}</span>
                    <div class="opponent-name">${opponent}</div>
                    <div class="opponent-games">ì´ ${stats.total}ì „</div>
                </div>
                <div class="opponent-chart">
                    <canvas id="chart-${index}" width="70" height="70"></canvas>
                    <div class="opponent-winrate">${winRate}%</div>
                </div>
            `;
            opponentStatsList.appendChild(opponentCard);

            new Chart(document.getElementById(`chart-${index}`), {
                type: 'doughnut',
                data: {
                    labels: ['ìŠ¹ë¦¬', 'ë¬´ìŠ¹ë¶€', 'íŒ¨ë°°'],
                    datasets: [{
                        data: [stats.wins, stats.draws, stats.losses],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        });
    }

    // Page Load Handler
    document.addEventListener("DOMContentLoaded", function() {
        const pathParts = window.location.pathname.split('/');
        const matchTypeName = decodeURIComponent(pathParts[pathParts.length - 1]);
        if (matchTypeName === 'ì»¤ìŠ¤í…€ë§¤ì¹˜') {
            const section = document.getElementById("opponentStatsSection");
            if (section) {
                section.style.display = 'block';
                calculateOpponentStats();
            }
        }
    });

    function selectGameMode(nick, mode) {
        const tabs = document.querySelectorAll('.tab-item');
        tabs.forEach(tab => tab.classList.remove('active'));
        event.currentTarget.classList.add('active');
        resultLoading();
        window.location.href = `/result.html?character_name=${nick}&match_type=${mode}`;
    }

    // Title Badges
    const influencerList = ["í•´ì„¤í•œìŠ¹ì—½", "ë©”ì‹œì—°", "êµë¡œí…”ë¦¬", "ë€¨ë€¨rr", "í˜¸ë‚ ë‘", "êµ´ë¦¬íŠ¸", "í¬ë¼ìš°í„°", "ì‰ìœ ì§„", "ì‹ ë¦¼ë™ë°€íƒ±í¬", "ë°©ë°°ìš°", "afë°•ì¤€íš¨", "ë¹…ìœˆ", "ê°ìŠ¤íŠ¸", "ì²œêµ­", "lictfe", "ìœ íŠœë¸Œì‹¸ì»¤ëŸ¬ë¦¬", "afê¹€ìš°ë‹¤", "ê¹€ì¹ í™", "íƒ€ì›Œ"];
    const proGamerList = ["gengë°•ì„¸ì˜", "ktê³½ì¤€í˜", "ktë°•ì°¬í™”", "kdfê°•ì¤€í˜¸", "kdfìµœí˜¸ì„", "kimyoomin"];
    const fifaInventKingList = ["í™”ì„±ê°„ì •ë¬´", "ë¬´ë¦¬ìœ¤ì£¼ë‹ˆì–´"];
    const firsttenList = ["pgzië°œ", "ê´€ì°°ë ¥", "agwí ë ˆ", "í ë ˆí•´ì ë‹¨", "ë§ˆí¬êµ¬3pop", "ë‚´ì¼ì´ë˜ë©´", "í„°ëŸ¬ê¸°fc", "ì™•ê¸ˆë³µ"];

    const nickname = "{{ level_data.nickname }}".toLowerCase();
    const titleBoxes = [document.getElementById("title-box"), document.getElementById("title-box-mobile")];

    function applyBadge(badgeText, badgeClass) {
        titleBoxes.forEach(titleBox => {
            if (titleBox) {
                titleBox.textContent = badgeText;
                titleBox.classList.add(badgeClass);
                titleBox.style.display = "inline-flex";
            }
        });
    }

    if (influencerList.includes(nickname)) {
        applyBadge("ì¸í”Œë£¨ì–¸ì„œ", "badge-influencer");
    } else if (proGamerList.includes(nickname)) {
        applyBadge("í”„ë¡œê²Œì´ë¨¸", "badge-progamer");
    } else if (fifaInventKingList.includes(nickname)) {
        applyBadge("í”¼íŒŒì¸ë²¤1í™©", "badge-inven");
    } else if (firsttenList.includes(nickname)) {
        applyBadge("ìµœì´ˆì˜ 10ì¸", "badge-firstten");
    }

    // Win Rate Stats
    const matchResults = {
        win: {{ match_data | selectattr('ê²°ê³¼', 'equalto', 'ìŠ¹') | list | length }},
        draw: {{ match_data | selectattr('ê²°ê³¼', 'equalto', 'ë¬´') | list | length }},
        lose: {{ match_data | selectattr('ê²°ê³¼', 'equalto', 'íŒ¨') | list | length }}
    };

    const totalGames = matchResults.win + matchResults.draw + matchResults.lose;
    const winRate = (matchResults.win / totalGames * 100).toFixed(1);

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const matchType = urlParams.get('match_type');
        if (matchType) {
            const tabs = document.querySelectorAll('.tab-item');
            tabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.tab-item[id='${matchType}']`);
            if (activeTab) activeTab.classList.add('active');
        }

        document.getElementById('winRatePercentage').textContent = `${winRate}%`;
        const winRateMessage = document.getElementById('winRateMessage');

        if (winRate < 30) {
            winRateMessage.textContent = "ìœ ì €ë‹˜ í˜¹ì‹œ íŒ¨ì‘.. ì•„ë‹ˆì‹œì£ ?";
            winRateMessage.style.color = '#ef4444';
        } else if (winRate < 40) {
            winRateMessage.textContent = "ì´ê±´ íŒ€ì˜ ë¬¸ì œì¼ ìˆ˜ë„ ìˆì–´ìš”..!";
            winRateMessage.style.color = '#ef4444';
        } else if (winRate < 50) {
            winRateMessage.textContent = "ìŠ¹ë¥ ì´ ì¢‹ì§€ì•Šì•„ìš”.. ì§€ê³  ê³„ì‹¤ê±´ê°€ìš”?";
            winRateMessage.style.color = '#ef4444';
        } else if (winRate < 60) {
            winRateMessage.textContent = "ê²½ê¸°ë ¥ì´ ì¢‹ì§€ë§Œ ë” ì˜í•´ì§€ì‹¤ ìˆ˜ ìˆì–´ìš”!";
            winRateMessage.style.color = '#f59e0b';
        } else if (winRate < 70) {
            winRateMessage.textContent = "ìµœê·¼ ì»¨ë””ì…˜ì´ ê±°ì˜ 12ì‹œì¸ë°ìš”?!";
            winRateMessage.style.color = '#f59e0b';
        } else if (winRate < 80) {
            winRateMessage.textContent = "ì™„ì „.. ë¶€ìºì˜ ëƒ„ìƒˆê°€ ë‚˜ëŠ”ë°ìš”?";
            winRateMessage.style.color = '#22c55e';
        } else {
            winRateMessage.textContent = "ìœ ì €ë‹˜ í˜¹ì‹œ.. í”„ë¡œê²Œì´ë¨¸ì´ì‹ ê°€ìš”?";
            winRateMessage.style.color = '#22c55e';
        }
    });

    // Search Handlers
    document.getElementById("character_name").addEventListener("keyup", function(event) {
        if (event.key === "Enter") document.getElementById("search_button").click();
    });

    document.getElementById("search_button").addEventListener("click", function() {
        var characterName = document.getElementById("character_name").value;
        if (characterName.trim() !== "") {
            resultLoading();
            setTimeout(function() {
                window.location.href = "/result.html?character_name=" + characterName + "&match_type=50";
            }, 10);
        }
    });

    window.addEventListener("pageshow", function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            document.getElementById("loading-win").style.display = "none";
            document.getElementById("loading-result").style.display = "none";
        }
    });

    function goToWinRateResult(nickname, match_type) {
        winLoading();
        setTimeout(function() {
            window.location.href = "/wr_result.html?character_name=" + nickname + "&match_type=" + match_type;
        }, 10);
    }

    function winLoading() {
        document.getElementById('loading-win').style.display = 'flex';
    }

    function resultLoading() {
        document.getElementById('loading-result').style.display = 'flex';
    }

    // Win Rate Chart
    const ctx = document.getElementById('winRateChart')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ìŠ¹ë¦¬', 'ë¬´ìŠ¹ë¶€', 'íŒ¨ë°°'],
                datasets: [{
                    data: [matchResults.win, matchResults.draw, matchResults.lose],
                    backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                return context.label + ': ' + context.raw + ' (' + Math.round((context.raw / total) * 100) + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Bookmark
    function toggleBookmark(nickname) {
        let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
        const index = bookmarks.indexOf(nickname);
        const btn = document.getElementById('bookmark-btn');
        if (index === -1) {
            bookmarks.push(nickname);
            if (btn) btn.classList.add('active');
        } else {
            bookmarks.splice(index, 1);
            if (btn) btn.classList.remove('active');
        }
        localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
    }

    document.addEventListener('DOMContentLoaded', () => {
        const bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
        const btn = document.getElementById('bookmark-btn');
        if (bookmarks.includes('{{ level_data.nickname }}')) {
            if (btn) btn.classList.add('active');
        }
    });
</script>
{% endblock %}
